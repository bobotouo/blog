import { readdirSync } from "node:fs";
import { join } from "node:path";
import { defineNuxtConfig } from "nuxt/config";

const collectRoutes = (dir: string, base: string): string[] => {
  try {
    const entries = readdirSync(dir, { withFileTypes: true });
    return entries
      .filter((entry) => entry.isFile())
      .map((entry) => entry.name)
      .filter((name) => name.endsWith(".md") || name.endsWith(".json"))
      .map((name) => name.replace(/\.(md|json)$/, ""))
      .map((slug) => `${base}/${slug}`);
  } catch {
    return [];
  }
};

const blogRoutes = collectRoutes(
  join(process.cwd(), "content", "blog"),
  "/blog",
);
const snapshotRoutes = collectRoutes(
  join(process.cwd(), "content", "snapshots"),
  "/snapshots",
);
const isGhPages = process.env.NUXT_GH_PAGES === "true";
const appBase =
  process.env.NUXT_APP_BASE_URL ||
  process.env.NUXT_PUBLIC_BASE_URL ||
  "/";
const normalizedBase = appBase.endsWith("/") ? appBase : `${appBase}/`;
const baseRoutes = ["/", "/blog", "/snapshots", ...blogRoutes, ...snapshotRoutes];
const prerenderRoutes = baseRoutes;

export default defineNuxtConfig({
  compatibilityDate: "2026-01-30",
  // Global page headers
  app: {
    head: {
      title: "个人博客",
      meta: [
        { charset: "utf-8" },
        { name: "viewport", content: "width=device-width,initial-scale=1" },
        { name: "description", content: "个人博客，使用 Nuxt 3 + Content" },
      ],
      link: [
        { rel: "preconnect", href: "https://fonts.googleapis.com" },
        { rel: "preconnect", href: "https://fonts.gstatic.com", crossorigin: "" },
      ],
    },
    pageTransition: { name: "page", mode: "out-in" },
    baseURL: appBase,
  },

  // Modules
  modules: [
    "@nuxt/content",
    "@nuxtjs/tailwindcss",
    "@pinia/nuxt",
    "@vueuse/nuxt",
  ],

  experimental: {
    payloadExtraction: false,
  },

  // Content module config
  content: {
    // files are placed under the `content/` directory
    // enable markdown frontmatter schema if needed later
    api: {
      baseURL: isGhPages ? `${normalizedBase}api/_content` : "/api/_content",
    },
    experimental: {
      clientDB: true,
    },
  },

  // TailwindCSS config path (generated by @nuxtjs/tailwindcss)
  css: ["@/assets/css/tailwind.css"],

  // Build settings
  build: {
    transpile: ["motion-v"],
  },

  ssr: true,
  nitro: {
    preset: isGhPages ? "static" : process.env.NITRO_PRESET || "netlify",
    prerender: isGhPages
      ? {
          crawlLinks: false,
          failOnError: false,
          routes: prerenderRoutes,
        }
      : {
          crawlLinks: true,
          failOnError: false,
          routes: prerenderRoutes,
        },
  },

  // 强制使用单一 Vue 实例，避免 motion-v 等库在 renderSlot 时 currentRenderingInstance 为 null
  vite: {
    resolve: {
      dedupe: ["vue", "vue-demi"],
    },
  },

  // Runtime config (placeholder for API keys etc.)
  runtimeConfig: {
    giscusToken: "",
    public: {
      giscusRepo: "",
      giscusRepoId: "",
      giscusCategory: "Announcements",
      giscusCategoryId: "",
      giscusTheme: "dark",
      statsBase: "",
      baseUrl: appBase,
    },
  },
});
