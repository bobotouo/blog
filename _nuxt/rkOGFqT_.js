import{j as E,g as x,h as I,o as g,c as b,E as L,u as v,b as B,T as H,w as q,a as y,H as A,q as f,L as z,f as C,_ as M}from"./1vecyTb1.js";import{u as V}from"./m4iM3arB.js";import{u as j}from"./jSp7Ygfm.js";const F={key:0,class:"comments-skeleton"},G={key:0,class:"text-sm text-white/60"},D=E({__name:"Comments",setup(a){const n=f(null),l=f(!1),r=f(!1);let i=null,o=null;const u=z(),p=u.public.giscusRepo||"",s=u.public.giscusRepoId||"",t=u.public.giscusCategory||"Announcements",m=u.public.giscusCategoryId||"",c=u.public.giscusTheme||"",O=c&&c!=="preferred_color_scheme"?c:"dark_dimmed",_=C(()=>!!p&&!!s&&!!m),R=C(()=>!1),T=C(()=>_.value&&!r.value);V({link:[{rel:"dns-prefetch",href:"https://giscus.app"},{rel:"dns-prefetch",href:"https://github.githubassets.com"},{rel:"preconnect",href:"https://giscus.app",crossorigin:""},{rel:"preconnect",href:"https://github.githubassets.com",crossorigin:""}]});const N=()=>{if(l.value||!n.value||!_.value)return;const e=document.createElement("script");e.src="https://giscus.app/client.js",e.async=!0,e.crossOrigin="anonymous",e.setAttribute("data-repo",p),e.setAttribute("data-repo-id",s),e.setAttribute("data-category",t),e.setAttribute("data-category-id",m),e.setAttribute("data-mapping","specific");const d=typeof window<"u"?window.location.pathname:"";d&&e.setAttribute("data-term",d),e.setAttribute("data-reactions-enabled","1"),e.setAttribute("data-emit-metadata","0"),e.setAttribute("data-input-position","bottom"),e.setAttribute("data-theme",O),e.setAttribute("data-lang","zh-CN"),n.value.appendChild(e),l.value=!0},h=e=>{e.getBoundingClientRect().height>=160&&(r.value=!0)},S=e=>{e.addEventListener("load",()=>{requestAnimationFrame(()=>{h(e)})}),o&&o.disconnect(),o=new ResizeObserver(()=>{h(e)}),o.observe(e)},w=()=>{if(!n.value)return;const e=n.value.querySelector(".giscus-frame");e&&(e.dataset.readyBound!=="1"&&(e.dataset.readyBound="1",S(e)),h(e))};return x(()=>{n.value&&(r.value=!1,i=new MutationObserver(()=>{w()}),i.observe(n.value,{childList:!0,subtree:!0}),N(),w())}),I(()=>{i&&(i.disconnect(),i=null),o&&(o.disconnect(),o=null)}),(e,d)=>(g(),b("div",{id:"comments",ref_key:"commentsContainer",ref:n,class:L([{"comments-ready":v(r)},"relative my-8 min-h-[18rem] rounded-2xl border border-white/10 bg-white/5 backdrop-blur-md p-4 md:min-h-[20rem] md:p-6"])},[B(H,{name:"skeleton-fade"},{default:q(()=>[v(T)?(g(),b("div",F,[...d[0]||(d[0]=[y("div",{class:"comments-skeleton-title"},null,-1),y("div",{class:"comments-skeleton-item"},null,-1),y("div",{class:"comments-skeleton-item"},null,-1)])])):A("",!0)]),_:1}),v(R)?(g(),b("p",G," 评论系统未配置：请在本地环境变量中设置 Giscus 参数后重启开发服务。 ")):A("",!0)],2))}}),Y=M(D,[["__scopeId","data-v-05cd51dc"]]),J=600*1e3,k="blog-comment-count-cache-v1",$=a=>{const n=f(null),l=j("comment-count-cache",()=>({})),r=()=>{try{const s=window.localStorage.getItem(k);if(!s)return{};const t=JSON.parse(s);return t&&typeof t=="object"?t:{}}catch{return{}}},i=s=>{try{window.localStorage.setItem(k,JSON.stringify(s))}catch{}},o=()=>{const s=Date.now(),t=l.value[a];if(t&&t.expiresAt>s)return t.comments;const c=r()[a];return c&&c.expiresAt>s?(l.value[a]=c,c.comments):null},u=s=>{const t={comments:s,expiresAt:Date.now()+J};l.value[a]=t;const m=r();m[a]=t,i(m)},p=async()=>{const s=o();if(s!==null){n.value=s;return}try{const t=await $fetch("/api/comments",{query:{path:a},timeout:4500});typeof t?.comments=="number"&&(n.value=t.comments,u(t.comments))}catch{}};return x(()=>{p()}),{count:n}};export{Y as _,$ as u};
