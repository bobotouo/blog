import{j as I,g as k,h as L,o as b,c as g,b as B,T as E,w as H,u as _,a as v,H as A,q as f,L as q,f as w,_ as z}from"./BzBcHu_U.js";import{u as M}from"./BRyLnJef.js";import{u as V}from"./ZBqmnshM.js";const j={key:0,class:"absolute inset-0 z-10 rounded-2xl bg-[rgba(10,14,20,0.72)] p-4 md:p-6 space-y-3"},F={key:0,class:"text-sm text-white/60"},G=I({__name:"Comments",setup(c){const n=f(null),u=f(!1),l=f(!1);let r=null,o=null;const i=q(),p=i.public.giscusRepo||"",s=i.public.giscusRepoId||"",t=i.public.giscusCategory||"Announcements",d=i.public.giscusCategoryId||"",a=i.public.giscusTheme||"",O=a&&a!=="preferred_color_scheme"?a:"dark_dimmed",y=w(()=>!!p&&!!s&&!!d),R=w(()=>!1),T=w(()=>y.value&&!l.value);M({link:[{rel:"dns-prefetch",href:"https://giscus.app"},{rel:"dns-prefetch",href:"https://github.githubassets.com"},{rel:"preconnect",href:"https://giscus.app",crossorigin:""},{rel:"preconnect",href:"https://github.githubassets.com",crossorigin:""}]});const N=()=>{if(u.value||!n.value||!y.value)return;const e=document.createElement("script");e.src="https://giscus.app/client.js",e.async=!0,e.crossOrigin="anonymous",e.setAttribute("data-repo",p),e.setAttribute("data-repo-id",s),e.setAttribute("data-category",t),e.setAttribute("data-category-id",d),e.setAttribute("data-mapping","specific");const m=typeof window<"u"?window.location.pathname:"";m&&e.setAttribute("data-term",m),e.setAttribute("data-reactions-enabled","1"),e.setAttribute("data-emit-metadata","0"),e.setAttribute("data-input-position","bottom"),e.setAttribute("data-theme",O),e.setAttribute("data-lang","zh-CN"),n.value.appendChild(e),u.value=!0},h=e=>{e.getBoundingClientRect().height>=160&&(l.value=!0)},S=e=>{e.addEventListener("load",()=>{requestAnimationFrame(()=>{h(e)})}),o&&o.disconnect(),o=new ResizeObserver(()=>{h(e)}),o.observe(e)},C=()=>{if(!n.value)return;const e=n.value.querySelector(".giscus-frame");e&&(e.dataset.readyBound!=="1"&&(e.dataset.readyBound="1",S(e)),h(e))};return k(()=>{n.value&&(l.value=!1,r=new MutationObserver(()=>{C()}),r.observe(n.value,{childList:!0,subtree:!0}),N(),C())}),L(()=>{r&&(r.disconnect(),r=null),o&&(o.disconnect(),o=null)}),(e,m)=>(b(),g("div",{id:"comments",ref_key:"commentsContainer",ref:n,class:"relative my-8 rounded-2xl border border-white/10 bg-white/5 backdrop-blur-md p-4 md:p-6"},[B(E,{name:"skeleton-fade"},{default:H(()=>[_(T)?(b(),g("div",j,[...m[0]||(m[0]=[v("div",{class:"h-4 w-40 rounded bg-white/10 animate-pulse"},null,-1),v("div",{class:"h-20 w-full rounded-xl bg-white/10 animate-pulse"},null,-1),v("div",{class:"h-20 w-full rounded-xl bg-white/10 animate-pulse"},null,-1)])])):A("",!0)]),_:1}),_(R)?(b(),g("p",F," 评论系统未配置：请在本地环境变量中设置 Giscus 参数后重启开发服务。 ")):A("",!0)],512))}}),K=z(G,[["__scopeId","data-v-277f1496"]]),D=600*1e3,x="blog-comment-count-cache-v1",Y=c=>{const n=f(null),u=V("comment-count-cache",()=>({})),l=()=>{try{const s=window.localStorage.getItem(x);if(!s)return{};const t=JSON.parse(s);return t&&typeof t=="object"?t:{}}catch{return{}}},r=s=>{try{window.localStorage.setItem(x,JSON.stringify(s))}catch{}},o=()=>{const s=Date.now(),t=u.value[c];if(t&&t.expiresAt>s)return t.comments;const a=l()[c];return a&&a.expiresAt>s?(u.value[c]=a,a.comments):null},i=s=>{const t={comments:s,expiresAt:Date.now()+D};u.value[c]=t;const d=l();d[c]=t,r(d)},p=async()=>{const s=o();if(s!==null){n.value=s;return}try{const t=await $fetch("/api/comments",{query:{path:c},timeout:4500});typeof t?.comments=="number"&&(n.value=t.comments,i(t.comments))}catch{}};return k(()=>{p()}),{count:n}};export{K as _,Y as u};
