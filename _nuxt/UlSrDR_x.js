import{j as E,g as R,h as I,o as y,c as C,E as L,u as _,b as H,T as U,w as $,a as w,H as x,q as g,L as T,f as A,_ as q}from"./CyUadsVW.js";import{u as z}from"./BQB7w36N.js";import{u as M}from"./DKNck-Sx.js";const V={key:0,class:"comments-skeleton"},j={key:0,class:"text-sm text-white/60"},F=E({__name:"Comments",setup(r){const n=g(null),m=g(!1),i=g(!1);let u=null,o=null;const l=T(),f=l.public.giscusRepo||"",t=l.public.giscusRepoId||"",s=l.public.giscusCategory||"Announcements",c=l.public.giscusCategoryId||"",a=l.public.giscusTheme||"",h=a&&a!=="preferred_color_scheme"?a:"dark_dimmed",b=A(()=>!!f&&!!t&&!!c),p=A(()=>!1),B=A(()=>b.value&&!i.value);z({link:[{rel:"dns-prefetch",href:"https://giscus.app"},{rel:"dns-prefetch",href:"https://github.githubassets.com"},{rel:"preconnect",href:"https://giscus.app",crossorigin:""},{rel:"preconnect",href:"https://github.githubassets.com",crossorigin:""}]});const N=()=>{if(m.value||!n.value||!b.value)return;const e=document.createElement("script");e.src="https://giscus.app/client.js",e.async=!0,e.crossOrigin="anonymous",e.setAttribute("data-repo",f),e.setAttribute("data-repo-id",t),e.setAttribute("data-category",s),e.setAttribute("data-category-id",c),e.setAttribute("data-mapping","specific");const d=typeof window<"u"?window.location.pathname:"";d&&e.setAttribute("data-term",d),e.setAttribute("data-reactions-enabled","1"),e.setAttribute("data-emit-metadata","0"),e.setAttribute("data-input-position","bottom"),e.setAttribute("data-theme",h),e.setAttribute("data-lang","zh-CN"),n.value.appendChild(e),m.value=!0},v=e=>{e.getBoundingClientRect().height>=160&&(i.value=!0)},S=e=>{e.addEventListener("load",()=>{requestAnimationFrame(()=>{v(e)})}),o&&o.disconnect(),o=new ResizeObserver(()=>{v(e)}),o.observe(e)},k=()=>{if(!n.value)return;const e=n.value.querySelector(".giscus-frame");e&&(e.dataset.readyBound!=="1"&&(e.dataset.readyBound="1",S(e)),v(e))};return R(()=>{n.value&&(i.value=!1,u=new MutationObserver(()=>{k()}),u.observe(n.value,{childList:!0,subtree:!0}),N(),k())}),I(()=>{u&&(u.disconnect(),u=null),o&&(o.disconnect(),o=null)}),(e,d)=>(y(),C("div",{id:"comments",ref_key:"commentsContainer",ref:n,class:L([{"comments-ready":_(i)},"relative my-8 min-h-[18rem] rounded-2xl border border-white/10 bg-white/5 backdrop-blur-md p-4 md:min-h-[20rem] md:p-6"])},[H(U,{name:"skeleton-fade"},{default:$(()=>[_(B)?(y(),C("div",V,[...d[0]||(d[0]=[w("div",{class:"comments-skeleton-title"},null,-1),w("div",{class:"comments-skeleton-item"},null,-1),w("div",{class:"comments-skeleton-item"},null,-1)])])):x("",!0)]),_:1}),_(p)?(y(),C("p",j," 评论系统未配置：请在本地环境变量中设置 Giscus 参数后重启开发服务。 ")):x("",!0)],2))}}),K=q(F,[["__scopeId","data-v-05cd51dc"]]),G=600*1e3,O="blog-comment-count-cache-v1",P=r=>{const n=g(null),m=M("comment-count-cache",()=>({})),i=()=>{try{const t=window.localStorage.getItem(O);if(!t)return{};const s=JSON.parse(t);return s&&typeof s=="object"?s:{}}catch{return{}}},u=t=>{try{window.localStorage.setItem(O,JSON.stringify(t))}catch{}},o=()=>{const t=Date.now(),s=m.value[r];if(s&&s.expiresAt>t)return s.comments;const a=i()[r];return a&&a.expiresAt>t?(m.value[r]=a,a.comments):null},l=t=>{const s={comments:t,expiresAt:Date.now()+G};m.value[r]=s;const c=i();c[r]=s,u(c)},f=async()=>{const t=o();if(t!==null){n.value=t;return}const s=T(),c=s.public.commentsApiBase||"",h=(s.public.baseUrl||"/").replace(/\/$/,""),b=c?`${c.replace(/\/$/,"")}/api/comments`:h?`${h}/api/comments`:"/api/comments";try{const p=await $fetch(b,{query:{path:r},timeout:4500});typeof p?.comments=="number"&&(n.value=p.comments,l(p.comments))}catch{}};return R(()=>{f()}),{count:n}};export{K as _,P as u};
