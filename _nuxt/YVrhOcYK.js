import{j as y,g as C,o as f,c as g,u as w,H as _,q as h,L as A,f as v}from"./B75qnUzs.js";import{u as x}from"./CDUjoJ8s.js";import{u as k}from"./BsXRXEDd.js";const T={key:0,class:"text-sm text-white/60"},E=y({__name:"Comments",setup(n){const s=h(null),r=h(!1),c=A(),u=c.public.giscusRepo||"",m=c.public.giscusRepoId||"",d=c.public.giscusCategory||"Announcements",l=c.public.giscusCategoryId||"",t=c.public.giscusTheme||"",e=t&&t!=="preferred_color_scheme"?t:"dark_dimmed",i=v(()=>!1);x({link:[{rel:"dns-prefetch",href:"https://giscus.app"},{rel:"dns-prefetch",href:"https://github.githubassets.com"},{rel:"preconnect",href:"https://giscus.app",crossorigin:""},{rel:"preconnect",href:"https://github.githubassets.com",crossorigin:""}]});const a=()=>{if(r.value||!s.value||!u||!m||!l)return;const o=document.createElement("script");o.src="https://giscus.app/client.js",o.async=!0,o.crossOrigin="anonymous",o.setAttribute("data-repo",u),o.setAttribute("data-repo-id",m),o.setAttribute("data-category",d),o.setAttribute("data-category-id",l),o.setAttribute("data-mapping","specific");const p=typeof window<"u"?window.location.pathname:"";p&&o.setAttribute("data-term",p),o.setAttribute("data-reactions-enabled","1"),o.setAttribute("data-emit-metadata","0"),o.setAttribute("data-input-position","bottom"),o.setAttribute("data-theme",e),o.setAttribute("data-lang","zh-CN"),s.value.appendChild(o),r.value=!0};return C(()=>{s.value&&a()}),(o,p)=>(f(),g("div",{id:"comments",ref_key:"commentsContainer",ref:s,class:"my-8 rounded-2xl border border-white/10 bg-white/5 backdrop-blur-md p-4 md:p-6"},[w(i)?(f(),g("p",T," 评论系统未配置：请在本地环境变量中设置 Giscus 参数后重启开发服务。 ")):_("",!0)],512))}}),I=600*1e3,b="blog-comment-count-cache-v1",H=n=>{const s=h(null),r=k("comment-count-cache",()=>({})),c=()=>{try{const t=window.localStorage.getItem(b);if(!t)return{};const e=JSON.parse(t);return e&&typeof e=="object"?e:{}}catch{return{}}},u=t=>{try{window.localStorage.setItem(b,JSON.stringify(t))}catch{}},m=()=>{const t=Date.now(),e=r.value[n];if(e&&e.expiresAt>t)return e.comments;const a=c()[n];return a&&a.expiresAt>t?(r.value[n]=a,a.comments):null},d=t=>{const e={comments:t,expiresAt:Date.now()+I};r.value[n]=e;const i=c();i[n]=e,u(i)},l=async()=>{const t=m();if(t!==null){s.value=t;return}try{const e=await $fetch("/api/comments",{query:{path:n},timeout:4500});typeof e?.comments=="number"&&(s.value=e.comments,d(e.comments))}catch{}};return C(()=>{l()}),{count:s}};export{E as _,H as u};
