import{j as S,g as x,h as E,o as b,c as g,E as L,u as v,b as q,T as B,w as H,a as w,H as k,q as f,L as z,f as C,_ as M}from"./Og3GdUtk.js";import{u as V}from"./BlgqvkKC.js";import{u as j}from"./CURaniLi.js";const F={key:0,class:"comments-skeleton"},G={key:0,class:"text-sm text-white/60"},D=S({__name:"Comments",setup(c){const n=f(null),l=f(!1),r=f(!1);let i=null,o=null;const u=z(),p=u.public.giscusRepo||"",s=u.public.giscusRepoId||"",t=u.public.giscusCategory||"Announcements",m=u.public.giscusCategoryId||"",a=u.public.giscusTheme||"",O=a&&a!=="preferred_color_scheme"?a:"dark_dimmed",y=C(()=>!!p&&!!s&&!!m),R=C(()=>!1),T=C(()=>y.value&&!r.value);V({link:[{rel:"dns-prefetch",href:"https://giscus.app"},{rel:"dns-prefetch",href:"https://github.githubassets.com"},{rel:"preconnect",href:"https://giscus.app",crossorigin:""},{rel:"preconnect",href:"https://github.githubassets.com",crossorigin:""}]});const I=()=>{if(l.value||!n.value||!y.value)return;const e=document.createElement("script");e.src="https://giscus.app/client.js",e.async=!0,e.crossOrigin="anonymous",e.setAttribute("data-repo",p),e.setAttribute("data-repo-id",s),e.setAttribute("data-category",t),e.setAttribute("data-category-id",m),e.setAttribute("data-mapping","specific");const d=typeof window<"u"?window.location.pathname:"";d&&e.setAttribute("data-term",d),e.setAttribute("data-reactions-enabled","1"),e.setAttribute("data-emit-metadata","0"),e.setAttribute("data-input-position","bottom"),e.setAttribute("data-theme",O),e.setAttribute("data-lang","zh-CN"),n.value.appendChild(e),l.value=!0},h=e=>{e.getBoundingClientRect().height>=160&&(r.value=!0)},N=e=>{e.addEventListener("load",()=>{requestAnimationFrame(()=>{h(e)})}),o&&o.disconnect(),o=new ResizeObserver(()=>{h(e)}),o.observe(e)},_=()=>{if(!n.value)return;const e=n.value.querySelector(".giscus-frame");e&&(e.dataset.readyBound!=="1"&&(e.dataset.readyBound="1",N(e)),h(e))};return x(()=>{n.value&&(r.value=!1,i=new MutationObserver(()=>{_()}),i.observe(n.value,{childList:!0,subtree:!0}),I(),_())}),E(()=>{i&&(i.disconnect(),i=null),o&&(o.disconnect(),o=null)}),(e,d)=>(b(),g("div",{id:"comments",ref_key:"commentsContainer",ref:n,class:L([{"comments-ready":v(r)},"relative my-8 min-h-[18rem] rounded-2xl border border-white/10 bg-white/5 backdrop-blur-md p-4 md:min-h-[20rem] md:p-6"])},[q(B,{name:"skeleton-fade"},{default:H(()=>[v(T)?(b(),g("div",F,[...d[0]||(d[0]=[w("div",{class:"comments-skeleton-title"},null,-1),w("div",{class:"comments-skeleton-item"},null,-1),w("div",{class:"comments-skeleton-item"},null,-1)])])):k("",!0)]),_:1}),v(R)?(b(),g("p",G," 评论系统未配置：请在本地环境变量中设置 Giscus 参数后重启开发服务。 ")):k("",!0)],2))}}),Y=M(D,[["__scopeId","data-v-05cd51dc"]]),J=600*1e3,A="blog-comment-count-cache-v1",$=c=>{const n=f(null),l=j("comment-count-cache",()=>({})),r=()=>{try{const s=window.localStorage.getItem(A);if(!s)return{};const t=JSON.parse(s);return t&&typeof t=="object"?t:{}}catch{return{}}},i=s=>{try{window.localStorage.setItem(A,JSON.stringify(s))}catch{}},o=()=>{const s=Date.now(),t=l.value[c];if(t&&t.expiresAt>s)return t.comments;const a=r()[c];return a&&a.expiresAt>s?(l.value[c]=a,a.comments):null},u=s=>{const t={comments:s,expiresAt:Date.now()+J};l.value[c]=t;const m=r();m[c]=t,i(m)},p=async()=>{const s=o();if(s!==null){n.value=s;return}try{const t=await $fetch("/api/comments",{query:{path:c},timeout:4500});typeof t?.comments=="number"&&(n.value=t.comments,u(t.comments))}catch{}};return x(()=>{if("requestIdleCallback"in window){window.requestIdleCallback(()=>p(),{timeout:2e3});return}window.setTimeout(()=>p(),900)}),{count:n}};export{Y as _,$ as u};
